(function() {
    "use strict";

    // 天气图标和概率配置
    const weatherData = {
        icons: {
            "阴云": 60203,
            "碧空": 60201,
            "晴朗": 60202,
            "薄雾": 60204,
            "小雨": 60207,
            "微风": 60205,
            "暴雨": 60208,
            "强风": 60206,
            "打雷": 60209,
            "雷雨": 60210,
            "扬沙": 60211,
            "热浪": 60214,
            "暴雪": 60216,
            "小雪": 60215,
            "妖雾": 60218,
            "灵电": 60220,
            "灵风": 60219,
            "月尘": 60222,
            "磁暴": 60223
        },
        rates: {
            "利姆萨·罗敏萨上层甲板": ["阴云", 20, "碧空", 50, "晴朗", 80, "薄雾", 90, "小雨"],
            "利姆萨·罗敏萨下层甲板": ["阴云", 20, "碧空", 50, "晴朗", 80, "薄雾", 90, "小雨"],
            "乌尔达哈现世回廊": ["碧空", 40, "晴朗", 60, "阴云", 85, "薄雾", 95, "小雨"],
            "乌尔达哈来生回廊": ["碧空", 40, "晴朗", 60, "阴云", 85, "薄雾", 95, "小雨"],
            "格里达尼亚新街": ["小雨", 5, "小雨", 20, "薄雾", 30, "阴云", 40, "晴朗", 55, "碧空", 85, "晴朗"],
            "格里达尼亚旧街": ["小雨", 5, "小雨", 20, "薄雾", 30, "阴云", 40, "晴朗", 55, "碧空", 85, "晴朗"],
            "中拉诺西亚": ["阴云", 20, "碧空", 50, "晴朗", 70, "微风", 80, "薄雾", 90, "小雨"],
            "拉诺西亚低地": ["阴云", 20, "碧空", 50, "晴朗", 70, "微风", 80, "薄雾", 90, "小雨"],
            "海雾村": ["阴云", 20, "碧空", 50, "晴朗", 70, "晴朗", 80, "薄雾", 90, "小雨"],
            "东拉诺西亚": ["薄雾", 5, "碧空", 50, "晴朗", 80, "阴云", 90, "小雨", 95, "暴雨"],
            "西拉诺西亚": ["薄雾", 10, "碧空", 40, "晴朗", 60, "阴云", 80, "微风", 90, "强风"],
            "拉诺西亚高地": ["碧空", 30, "晴朗", 50, "阴云", 70, "薄雾", 80, "打雷", 90, "雷雨"],
            "西萨纳兰": ["碧空", 40, "晴朗", 60, "阴云", 85, "薄雾", 95, "小雨"],
            "中萨纳兰": ["扬沙", 15, "碧空", 55, "晴朗", 75, "阴云", 85, "薄雾", 95, "小雨"],
            "东萨纳兰": ["碧空", 40, "晴朗", 60, "阴云", 70, "薄雾", 80, "小雨", 85, "暴雨"],
            "南萨纳兰": ["热浪", 20, "碧空", 60, "晴朗", 80, "阴云", 90, "薄雾"],
            "北萨纳兰": ["碧空", 5, "晴朗", 20, "阴云", 50, "薄雾"],
            "黑衣森林中央林区": ["打雷", 5, "小雨", 20, "薄雾", 30, "阴云", 40, "晴朗", 55, "碧空", 85, "晴朗"],
            "黑衣森林东部林区": ["打雷", 5, "小雨", 20, "薄雾", 30, "阴云", 40, "晴朗", 55, "碧空", 85, "晴朗"],
            "黑衣森林南部林区": ["薄雾", 5, "雷雨", 10, "打雷", 25, "薄雾", 30, "阴云", 40, "晴朗", 70, "碧空"],
            "黑衣森林北部林区": ["薄雾", 5, "暴雨", 10, "小雨", 25, "薄雾", 30, "阴云", 40, "晴朗", 70, "碧空"],
            "库尔札斯中央高地": ["暴雪", 20, "小雪", 60, "晴朗", 70, "碧空", 75, "阴云", 90, "薄雾"],
            "摩杜纳": ["阴云", 15, "薄雾", 30, "妖雾", 60, "碧空", 75, "晴朗"],
            "拉诺西亚外地": ["碧空", 30, "晴朗", 50, "阴云", 70, "薄雾", 85, "小雨"],
            "狼狱停船场": ["阴云", 20, "碧空", 50, "晴朗", 80, "薄雾", 90, "雷雨"],
            "薰衣草苗圃": ["阴云", 5, "小雨", 20, "薄雾", 30, "阴云", 40, "晴朗", 55, "碧空", 85, "晴朗"],
            "高脚孤丘": ["碧空", 40, "晴朗", 60, "阴云", 85, "薄雾", 95, "小雨"],
            "库尔札斯西部高地": ["暴雪", 20, "小雪", 60, "晴朗", 70, "碧空", 75, "阴云", 90, "薄雾"],
            "龙堡参天高地": ["阴云", 10, "薄雾", 20, "打雷", 30, "扬沙", 40, "碧空", 70, "晴朗"],
            "龙堡内陆低地": ["阴云", 10, "薄雾", 20, "小雨", 30, "暴雨", 40, "碧空", 70, "晴朗"],
            "翻云雾海": ["阴云", 10, "强风", 20, "灵电", 40, "碧空", 70, "晴朗"],
            "阿巴拉提亚云海": ["碧空", 30, "晴朗", 60, "阴云", 70, "薄雾", 80, "微风", 90, "灵风"],
            "魔大陆阿济兹拉": ["晴朗", 35, "阴云", 70, "打雷"],
            "伊修加德基础层": ["小雪", 60, "晴朗", 70, "碧空", 75, "阴云", 90, "薄雾"],
            "伊修加德砥柱层": ["小雪", 60, "晴朗", 70, "碧空", 75, "阴云", 90, "薄雾"],
            "田园郡": ["阴云", 10, "薄雾", 20, "小雨", 30, "暴雨", 40, "碧空", 70, "晴朗"],
            "基拉巴尼亚边区": ["碧空", 15, "晴朗", 60, "阴云", 80, "薄雾", 90, "打雷"],
            "红玉海": ["打雷", 10, "微风", 20, "阴云", 35, "晴朗", 75, "碧空"],
            "延夏": ["暴雨", 5, "小雨", 15, "薄雾", 25, "阴云", 40, "晴朗", 80, "碧空"],
            "基拉巴尼亚山区": ["碧空", 10, "晴朗", 60, "阴云", 75, "薄雾", 85, "微风", 95, "扬沙"],
            "基拉巴尼亚湖区": ["碧空", 20, "晴朗", 60, "阴云", 80, "薄雾", 90, "雷雨"],
            "太阳神草原": ["强风", 5, "微风", 10, "小雨", 17, "薄雾", 25, "阴云", 35, "晴朗", 75, "碧空"],
            "黄金港": ["小雨", 10, "薄雾", 20, "阴云", 40, "晴朗", 80, "碧空"],
            "神拳痕": ["碧空", 15, "晴朗", 60, "阴云", 80, "薄雾", 90, "打雷"],
            "白银乡": ["小雨", 10, "薄雾", 20, "阴云", 40, "晴朗", 80, "碧空"],
            "优雷卡常风之地": ["晴朗", 30, "强风", 60, "暴雨", 90, "小雪"],
            "优雷卡恒冰之地": ["晴朗", 10, "薄雾", 28, "热浪", 46, "小雪", 64, "打雷", 82, "暴雪"],
            "优雷卡涌火之地": ["晴朗", 10, "热浪", 28, "打雷", 46, "暴雪", 64, "灵风", 82, "小雪"],
            "雷克兰德": ["碧空", 20, "晴朗", 60, "阴云", 75, "薄雾", 85, "小雨", 95, "雷雨"],
            "珂露西亚岛": ["强风", 10, "小雨", 20, "薄雾", 30, "阴云", 45, "晴朗", 85, "碧空"],
            "安穆·艾兰": ["晴朗", 45, "阴云", 60, "扬沙", 70, "热浪", 80, "碧空"],
            "伊尔美格": ["小雨", 10, "薄雾", 20, "阴云", 35, "雷雨", 45, "碧空", 60, "晴朗"],
            "拉凯提卡大森林": ["薄雾", 10, "小雨", 20, "灵风", 30, "碧空", 45, "晴朗", 85, "阴云"],
            "黑风海": ["阴云", 20, "晴朗", 80, "碧空"],
            "水晶都": ["碧空", 20, "晴朗", 60, "阴云", 75, "薄雾", 85, "小雨", 95, "雷雨"],
            "游末邦": ["强风", 10, "小雨", 20, "薄雾", 30, "阴云", 45, "晴朗", 85, "碧空"],
            "优雷卡丰水之地": ["晴朗", 12, "暴雨", 34, "妖雾", 56, "雷雨", 78, "小雪"],
            "南方博兹雅战线": ["晴朗", 52, "小雨", 64, "微风", 76, "打雷", 88, "扬沙"],
            "迷津": ["碧空", 15, "晴朗", 60, "阴云", 85, "小雨"],
            "萨维奈岛": ["薄雾", 10, "小雨", 20, "暴雨", 25, "碧空", 40, "晴朗", 80, "阴云"],
            "加雷马": ["小雪", 45, "打雷", 50, "小雨", 55, "薄雾", 60, "阴云", 85, "晴朗", 95, "碧空"],
            "叹息海": ["灵风", 15, "月尘", 30, "晴朗"],
            "天外天垓": ["磁暴", 15, "晴朗", 85, "灵风"],
            "厄尔庇斯": ["阴云", 25, "灵风", 40, "晴朗", 85, "碧空"],
            "旧萨雷安": ["碧空", 10, "晴朗", 50, "阴云", 70, "薄雾", 85, "小雪"],
            "拉札罕": ["薄雾", 10, "小雨", 25, "碧空", 40, "晴朗", 80, "阴云"],
            "扎杜诺尔高原": ["晴朗", 60, "小雨", 70, "微风", 80, "打雷", 90, "小雪"]
        },
        areas: [
            ["拉诺西亚", "利姆萨·罗敏萨上层甲板", "中拉诺西亚", "拉诺西亚低地", "东拉诺西亚", "西拉诺西亚", "拉诺西亚高地", "拉诺西亚外地", "狼狱停船场", "海雾村"], ["黑衣森林", "格里达尼亚新街", "黑衣森林中央林区", "黑衣森林东部林区", "黑衣森林南部林区", "黑衣森林北部林区", "薰衣草苗圃"], ["萨纳兰", "乌尔达哈现世回廊", "西萨纳兰", "中萨纳兰", "东萨纳兰", "南萨纳兰", "北萨纳兰", "高脚孤丘"], ["库尔札斯", "伊修加德基础层", "库尔札斯中央高地", "库尔札斯西部高地"], ["阿巴拉提亚", "阿巴拉提亚云海", "魔大陆阿济兹拉"], ["龙堡", "田园郡", "龙堡参天高地", "龙堡内陆低地", "翻云雾海"], ["基拉巴尼亚", "神拳痕", "基拉巴尼亚边区", "基拉巴尼亚山区", "基拉巴尼亚湖区"], ["远东之国", "黄金港", "白银乡"], ["奥萨德", "红玉海", "延夏", "太阳神草原"], ["诺弗兰特", "水晶都", "游末邦", "雷克兰德", "珂露西亚岛", "安穆·艾兰", "伊尔美格", "拉凯提卡大森林", "黑风海"], ["摩杜纳", "摩杜纳"], ["伊尔萨巴德", "拉札罕", "萨维奈岛", "加雷马"], ["北洋地域", "旧萨雷安", "迷津"], ["星外天域", "叹息海", "天外天垓"], ["古代世界", "厄尔庇斯"], ["优雷卡", "优雷卡常风之地", "优雷卡恒冰之地", "优雷卡涌火之地", "优雷卡丰水之地"], ["博兹雅", "南方博兹雅战线", "扎杜诺尔高原"]
        ],
        locationAliases: {
            "利姆萨·罗敏萨上层甲板": "利姆萨·罗敏萨",
            "格里达尼亚新街": "格里达尼亚",
            "乌尔达哈现世回廊": "乌尔达哈",
            "伊修加德基础层": "伊修加德"
        }
    };

    // 常量定义
    const EORZEAN_HOUR = 175 * 1000; // 1 ET小时 = 175秒现实时间
    const WEATHER_DURATION = 8 * EORZEAN_HOUR; // 天气持续时间 (8 ET小时)

    class Weather {
        constructor() {
            this._weatherData = Object.freeze(weatherData);
        }

        get icons() {
            return this._weatherData.icons;
        }

        get areas() {
            return this._weatherData.areas.map(region =>
                region.map(loc => this._weatherData.locationAliases[loc] || loc)
            );
        }

        // 获取有效天气类型
        getValidWeathers(location) {
            const rates = this._getRates(location);
            return rates ? rates.filter(item => typeof item !== 'number') : null;
        }

        // 获取指定时间的天气
        getWeather(location, timestamp = Date.now()) {
            const rates = this._getRates(location);
            if (!rates) return null;

            const weatherChance = this._calculateWeatherChance(timestamp);

            for (let i = 0; ; i++) {
                const thresholdIndex = 2 * i + 1;
                if (thresholdIndex >= rates.length) break;
                if (weatherChance < rates[thresholdIndex]) {
                    return rates[2 * i];
                }
            }
            return rates[rates.length - 1];
        }

        // 获取艾欧泽亚时间
        getEorzeanTimes(timestamp, includeDate = false) {
            timestamp = Math.abs(timestamp || Date.now());
            const totalSeconds = Math.round(timestamp / (175 / 60)) / 1000;
            const minutes = Math.floor(totalSeconds / 60);

            if (!includeDate) {
                return [totalSeconds % 60, minutes % 24];
            }

            const days = Math.floor(minutes / 24);
            return [
                totalSeconds % 60,  // 秒
                minutes % 24,       // 小时
                days % 32 + 1,      // 日
                Math.floor(days / 32) % 12 + 1 // 月
            ];
        }

        // 私有方法
        _getRates(location) {
            const actualLocation = this._getActualLocationName(location);
            return this._weatherData.rates[actualLocation];
        }

        _getActualLocationName(location) {
            for (const [key, value] of Object.entries(this._weatherData.locationAliases)) {
                if (value === location) return key;
            }
            return location;
        }

        _calculateWeatherChance(timestamp) {
            timestamp = Math.abs(timestamp || Date.now());
            const totalSeconds = Math.floor(timestamp / 1000);
            const bell = Math.floor(totalSeconds / 175);

            // 计算天气概率
            const weatherSeed = (bell + 8 - bell % 8) % 24;
            const weatherChanceBase = 100 * (Math.floor(totalSeconds / 4200) >>> 0) + weatherSeed;
            const weatherChance = ((weatherChanceBase << 11 ^ weatherChanceBase) >>> 0);
            return ((weatherChance >>> 8 ^ weatherChance) >>> 0) % 100;
        }
    }

    // 导出到全局或模块
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = Weather;
    } else if (typeof window !== 'undefined') {
        window.Weather = Weather;
    }
})();